clear all
close all
clc
% %-----------------------------------------------------------------------------------------------------
% Load the PET Image
% %-----------------------------------------------------------------------------------------------------
sxy = 336; % Dimensions for the PET Image
sz = 110;
% %-----------------------------------------------------------------------------------------------------
fid=fopen('G:\Benveniste\Subject4\Subject4-Interfile.img'); % I saved the DICOM PET Image as Interfile because its easier to work with
img1 = fread(fid,'float32');
img1 = reshape(img1, sxy,sxy,sz);
fclose(fid);
% %-----------------------------------------------------------------------------------------------------
% Subject 4
T = 48.13;
% %-----------------------------------------------------------------------------------------------------
% Blood data
% Time (seconds)
t = [0 10 20 30 40 50 60 70 80 90 100 110 120 180 240 360 480 600 900 1200 1500 1800 2100 3944]; 
t= t / 60;
% %-----------------------------------------------------------------------------------------------------
% Average Plasma Glucose Concentration(mg/dl)
% %-----------------------------------------------------------------------------------------------------
% Subject 4
Cp = 74;
% %-----------------------------------------------------------------------------------------------------
Cp = Cp / 18;
% %-----------------------------------------------------------------------------------------------------
% Decay Corrected (scan start) Counts (nCi), taken from excel sheet by multiplying by the volume
% %-----------------------------------------------------------------------------------------------------
% % Subject 4
Cp_star_p = [0.03 0.01 0.09 0.04 2.64 85.56 312.56 249.11 306.40 275.69 242.34 216.95 192.63 141.28 133.81 119.22 109.59 101.19 86.80 80.56 70.43 68.73 61.38 50.29]; 
Cp_star_p = Cp_star_p * 0.037; % Convert to kBq
Cp_star_p = Cp_star_p / 60; % Convert to kBq/s

% Cp_star_p = [0.083 0.065 0.161 0.098 3.117 98.650 357.800 282.900 345.400 308.600 269.600 240.700 211.200 154.000 144.900 128.400 117.400 107.800 91.980 84.890 73.720 71.400 58.68 47.640];
% Cp_star_p = Cp_star_p / 1000;
% Cp_star_p = Cp_star_p / 60; % Convert to cps
% %-----------------------------------------------------------------------------------------------------
tq = 0 : 10 : 3940;
tq = tq / 60;
Cp_star = interp1(t,Cp_star_p,tq);

MRGlu_img = zeros(sxy,sxy,sz); % Create an empty array to improve speed
% Graham 2002 Parameters
LC=0.89;
k_1 = 0.121;
k_2 = 0.172;
k_3 = 0.125;
k_4 = 0.0089;
% %-----------------------------------------------------------------------------------------------------
a_1 = ((k_2 + k_3 + k_4 - sqrt(((k_2 + k_3 + k_4).^2)-4*k_2*k_4)) / 2);
a_2 = ((k_2 + k_3 + k_4 + sqrt(((k_2 + k_3 + k_4).^2)-4*k_2*k_4)) / 2);
% %------------------------------------------------------------------------
c_1 = (k_1 / (a_2 - a_1));
c_2 = (k_4 - a_1);
c_3 = (a_2 - k_4);
c_4 = ((k_2 + k_3) / (a_2 - a_1));
% %-----------------------------------------------------------------------------------------------------
% for i = 1 : numel(MRGlu_img)
%         MRGlu_img(i) = (Cp*(median(diff(xq))*conv(img1(i)-c_1*(c_2*exp(-a_1*T)+c_3*exp(-a_2*T)),Cp_star,'same'))) / (median(diff(xq))*conv(LC*c_4*(exp(-a_1*T)-exp(-a_2*T)),Cp_star,'same')); % from Huanng et al.
%         MRGlu_img(i) = (Cp*(conv(img1(i)-c_1*(c_2*exp(-a_1*T)+c_3*exp(-a_2*T)),Cp_star,'same'))) / (conv(LC*c_4*(exp(-a_1*T)-exp(-a_2*T)),Cp_star,'same')); % from Huanng et al.
% end

conv_result1 = c_1.*conv(c_2*exp(-a_1*tq)+c_3*exp(-a_2*tq),Cp_star,'same');
conv_result2 = LC*c_4.*conv(exp(-a_1*tq)-exp(-a_2*tq),Cp_star,'same');

conv_result1_p = interp1(tq,conv_result1,T);    
conv_result2_p = interp1(tq,conv_result2,T); 
     
MRGlu_img = Cp*(img1-conv_result1_p)/conv_result2_p;

% %-----------------------------------------------------------------------------------------------------
fid = fopen('G:\Benveniste\Subject4\MATLAB_MRGLu.img','w');
fwrite(fid,MRGlu_img,'float32');
fclose(fid);
% %-----------------------------------------------------------------------------------------------------